<p>Most reccomender examples utilize the MovieLense dataset, but that relies only on ratings (which makes the recommender being demonstrated look less trivial).  Right next to the MovieLense dataset is the LastFM data set.  The LastFM dataset has ratings by user, friends of the user, bands listened to by user, and tags by user.  This is the kind of exciting data set we’d like to work with!</p>

<p>Start by downloading the LastFM dataset from 
http://files.grouplens.org/datasets/hetrec2011/hetrec2011-lastfm-2k.zip</p>

<p>I’m going to assume you’ve unzipped them to /path/to/lastfm/*
We’re going to use a new trick for creating our IndexedDataSets, the <code class="highlighter-rouge">apply</code> function.  <code class="highlighter-rouge">apply</code> takes an <code class="highlighter-rouge">RDD[(String, String)]</code> that is an RDD of tuples where both elements are strings. We load RDDs, and use Spark to manipulate the RDDs into this form.  The files from LastFM are tab seperated- but it should be noted, that this could easily be done from log files, but would just take a touch more Spark-Fu.</p>

<p>The second important thing to note is that the first element in each tuple is going to be the rows in the resulting matrix, the second element will be the column, and at that position there will be a one.  The BiDictionary will automatically be created from the strings. 
For those following along at home- <a href="cco-lastfm.scala">the full Scala worksheet</a> might be easier than copying and pasting 
from this page.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">org.apache.mahout.sparkbindings.indexeddataset.IndexedDatasetSpark</span>

<span class="k">val</span> <span class="n">userTagsRDD</span> <span class="k">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">textFile</span><span class="o">(</span><span class="s">"/path/to/lastfm/user_taggedartists.dat"</span><span class="o">)</span>
<span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">line</span> <span class="k">=&gt;</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="o">(</span><span class="s">"\t"</span><span class="o">))</span>
<span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">a</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="n">a</span><span class="o">(</span><span class="mi">0</span><span class="o">),</span> <span class="n">a</span><span class="o">(</span><span class="mi">2</span><span class="o">)))</span>
<span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">_1</span> <span class="o">!=</span> <span class="s">"userID"</span><span class="o">)</span>
<span class="k">val</span> <span class="n">userTagsIDS</span> <span class="k">=</span> <span class="nc">IndexedDatasetSpark</span><span class="o">.</span><span class="n">apply</span><span class="o">(</span><span class="n">userTagsRDD</span><span class="o">)(</span><span class="n">sc</span><span class="o">)</span>

<span class="k">val</span> <span class="n">userArtistsRDD</span> <span class="k">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">textFile</span><span class="o">(</span><span class="s">"/path/to/lastfm/user_artists.dat"</span><span class="o">)</span>
													<span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">line</span> <span class="k">=&gt;</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="o">(</span><span class="s">"\t"</span><span class="o">))</span>
													<span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">a</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="n">a</span><span class="o">(</span><span class="mi">0</span><span class="o">),</span> <span class="n">a</span><span class="o">(</span><span class="mi">1</span><span class="o">)))</span>
										      <span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">_1</span> <span class="o">!=</span> <span class="s">"userID"</span><span class="o">)</span>
										      
<span class="k">val</span> <span class="n">userArtistsIDS</span> <span class="k">=</span> <span class="nc">IndexedDatasetSpark</span><span class="o">.</span><span class="n">apply</span><span class="o">(</span><span class="n">userArtistsRDD</span><span class="o">)(</span><span class="n">sc</span><span class="o">)</span>

<span class="k">val</span> <span class="n">userFriendsRDD</span> <span class="k">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">textFile</span><span class="o">(</span><span class="s">"/path/to/lastfm/user_friends.dat"</span><span class="o">)</span>
                          <span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">line</span> <span class="k">=&gt;</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="o">(</span><span class="s">"\t"</span><span class="o">))</span>
                          <span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">a</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="n">a</span><span class="o">(</span><span class="mi">0</span><span class="o">),</span> <span class="n">a</span><span class="o">(</span><span class="mi">1</span><span class="o">)))</span>
                          <span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">_1</span> <span class="o">!=</span> <span class="s">"userID"</span><span class="o">)</span>
                          
<span class="k">val</span> <span class="n">userFriendsIDS</span> <span class="k">=</span> <span class="nc">IndexedDatasetSpark</span><span class="o">.</span><span class="n">apply</span><span class="o">(</span><span class="n">userFriendsRDD</span><span class="o">)(</span><span class="n">sc</span><span class="o">)</span>
</code></pre></div></div>

<p>How much easier was that?! In each RDD creations we:</p>

<p>Load our data using sc.textFile</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sc.textFile("/path/to/lastfm/user_taggedartists.dat")
</code></pre></div></div>

<p>Split the data into an array based on tabs (\t)</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.map(line =&gt; line.split("\t"))
</code></pre></div></div>

<p>Pull the userID column into the first position of the tuple, and the other attribute we want into the second position.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.map(a =&gt; (a(0), a(1)))
</code></pre></div></div>

<p>Remove the header (the only line that will have “userID” in that position)</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.filter(_._1 != "userID")
</code></pre></div></div>

<p>Then we easily create an IndexedDataSet using the <code class="highlighter-rouge">apply</code> method. 
val userTagsIDS = IndexedDatasetSpark.apply(userTagsRDD)(sc)
Note the <code class="highlighter-rouge">(sc)</code> at the end. You may or may not need that.  <code class="highlighter-rouge">sc</code> is the SparkContext and should be passed as an implicit parameter, however the REPL environment (e.g. Mahout Shell or notebooks) has a hard time with the implicits, so I had to pass it explicitly.</p>

<p>Now we compute our co-occurrence matrices:</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">org.apache.mahout.math.cf.SimilarityAnalysis</span>

<span class="k">val</span> <span class="n">artistReccosLlrDrmListByArtist</span> <span class="k">=</span> <span class="nc">SimilarityAnalysis</span><span class="o">.</span><span class="n">cooccurrencesIDSs</span><span class="o">(</span>
			<span class="nc">Array</span><span class="o">(</span><span class="n">userArtistsIDS</span><span class="o">,</span> <span class="n">userTagsIDS</span><span class="o">,</span> <span class="n">userFriendsIDS</span><span class="o">),</span> 
						<span class="n">maxInterestingItemsPerThing</span> <span class="k">=</span> <span class="mi">20</span><span class="o">,</span>
						<span class="n">maxNumInteractions</span> <span class="k">=</span> <span class="mi">500</span><span class="o">,</span> 
						<span class="n">randomSeed</span> <span class="k">=</span> <span class="mi">1234</span><span class="o">)</span>
</code></pre></div></div>

<p>Let’s see an example of how this would work-</p>

<p>First we have a small problem. If you look at our original input files, the userIDs, artistIDs, and tags were all integers. We loaded them as strings and if you look at the BiDictionaries associated with each IDS, you’ll see they map the original integers as strings to the integer indices of our matrix. Not super helpful.  There are other files which contain mappings from LastFM ID to human readable band and tag names.  I could have sorted this out in the begining but I chose to do it on the backside because it is a bit of clever Spark/Scala only needed to work around a quirk in this particular dataset.  We have to reverse map a few things if we want to input ‘human readable’ attributes, which I did.  If this doesn’t make sense, please don’t be discouraged- the important part was above, this is just some magic for working with this dataset in a pretty way.</p>

<p>First I load, and create incore maps from the mapping files:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="n">artistMap</span> <span class="k">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">textFile</span><span class="o">(</span><span class="s">"/path/to/lastfm/artists.dat"</span><span class="o">)</span>
  <span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">line</span> <span class="k">=&gt;</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="o">(</span><span class="s">"\t"</span><span class="o">))</span>
  <span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">a</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="n">a</span><span class="o">(</span><span class="mi">1</span><span class="o">),</span> <span class="n">a</span><span class="o">(</span><span class="mi">0</span><span class="o">)))</span>
  <span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">_1</span> <span class="o">!=</span> <span class="s">"name"</span><span class="o">)</span>
  <span class="o">.</span><span class="n">collect</span>
  <span class="o">.</span><span class="n">toMap</span>

<span class="k">val</span> <span class="n">tagsMap</span> <span class="k">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">textFile</span><span class="o">(</span><span class="s">"/path/tolastfm/tags.dat"</span><span class="o">)</span>
  <span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">line</span> <span class="k">=&gt;</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="o">(</span><span class="s">"\t"</span><span class="o">))</span>
  <span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">a</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="n">a</span><span class="o">(</span><span class="mi">1</span><span class="o">),</span> <span class="n">a</span><span class="o">(</span><span class="mi">0</span><span class="o">)))</span>
  <span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">_1</span> <span class="o">!=</span> <span class="s">"tagValue"</span><span class="o">)</span>
  <span class="o">.</span><span class="n">collect</span>
  <span class="o">.</span><span class="n">toMap</span>

</code></pre></div></div>

<p>This will create some <code class="highlighter-rouge">Map</code>s that I can use to type readable names for the artist and tags to create my ‘history’.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="n">kilroyUserArtists</span> <span class="k">=</span> <span class="n">svec</span><span class="o">(</span> <span class="o">(</span><span class="n">userArtistsIDS</span><span class="o">.</span><span class="n">columnIDs</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">artistMap</span><span class="o">(</span><span class="s">"Beck"</span><span class="o">)).</span><span class="n">get</span><span class="o">,</span> <span class="mi">1</span><span class="o">)</span> <span class="o">::</span>
 <span class="o">(</span><span class="n">userArtistsIDS</span><span class="o">.</span><span class="n">columnIDs</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">artistMap</span><span class="o">(</span><span class="s">"David Bowie"</span><span class="o">)).</span><span class="n">get</span><span class="o">,</span> <span class="mi">1</span><span class="o">)</span> <span class="o">::</span>
 <span class="o">(</span><span class="n">userArtistsIDS</span><span class="o">.</span><span class="n">columnIDs</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">artistMap</span><span class="o">(</span><span class="s">"Gary Numan"</span><span class="o">)).</span><span class="n">get</span><span class="o">,</span> <span class="mi">1</span><span class="o">)</span> <span class="o">::</span>
 <span class="o">(</span><span class="n">userArtistsIDS</span><span class="o">.</span><span class="n">columnIDs</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">artistMap</span><span class="o">(</span><span class="s">"Less Than Jake"</span><span class="o">)).</span><span class="n">get</span><span class="o">,</span> <span class="mi">1</span><span class="o">)</span> <span class="o">::</span>
 <span class="o">(</span><span class="n">userArtistsIDS</span><span class="o">.</span><span class="n">columnIDs</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">artistMap</span><span class="o">(</span><span class="s">"Lou Reed"</span><span class="o">)).</span><span class="n">get</span><span class="o">,</span> <span class="mi">1</span><span class="o">)</span> <span class="o">::</span>
 <span class="o">(</span><span class="n">userArtistsIDS</span><span class="o">.</span><span class="n">columnIDs</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">artistMap</span><span class="o">(</span><span class="s">"Parliament"</span><span class="o">)).</span><span class="n">get</span><span class="o">,</span> <span class="mi">1</span><span class="o">)</span> <span class="o">::</span>
 <span class="o">(</span><span class="n">userArtistsIDS</span><span class="o">.</span><span class="n">columnIDs</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">artistMap</span><span class="o">(</span><span class="s">"Radiohead"</span><span class="o">)).</span><span class="n">get</span><span class="o">,</span> <span class="mi">1</span><span class="o">)</span> <span class="o">::</span>
 <span class="o">(</span><span class="n">userArtistsIDS</span><span class="o">.</span><span class="n">columnIDs</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">artistMap</span><span class="o">(</span><span class="s">"Seu Jorge"</span><span class="o">)).</span><span class="n">get</span><span class="o">,</span> <span class="mi">1</span><span class="o">)</span> <span class="o">::</span>
 <span class="o">(</span><span class="n">userArtistsIDS</span><span class="o">.</span><span class="n">columnIDs</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">artistMap</span><span class="o">(</span><span class="s">"The Skatalites"</span><span class="o">)).</span><span class="n">get</span><span class="o">,</span> <span class="mi">1</span><span class="o">)</span> <span class="o">::</span>
 <span class="o">(</span><span class="n">userArtistsIDS</span><span class="o">.</span><span class="n">columnIDs</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">artistMap</span><span class="o">(</span><span class="s">"Reverend Horton Heat"</span><span class="o">)).</span><span class="n">get</span><span class="o">,</span> <span class="mi">1</span><span class="o">)</span> <span class="o">::</span>
 <span class="o">(</span><span class="n">userArtistsIDS</span><span class="o">.</span><span class="n">columnIDs</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">artistMap</span><span class="o">(</span><span class="s">"Talking Heads"</span><span class="o">)).</span><span class="n">get</span><span class="o">,</span> <span class="mi">1</span><span class="o">)</span> <span class="o">::</span>
 <span class="o">(</span><span class="n">userArtistsIDS</span><span class="o">.</span><span class="n">columnIDs</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">artistMap</span><span class="o">(</span><span class="s">"Tom Waits"</span><span class="o">)).</span><span class="n">get</span><span class="o">,</span> <span class="mi">1</span><span class="o">)</span> <span class="o">::</span>
 <span class="o">(</span><span class="n">userArtistsIDS</span><span class="o">.</span><span class="n">columnIDs</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">artistMap</span><span class="o">(</span><span class="s">"Waylon Jennings"</span><span class="o">)).</span><span class="n">get</span><span class="o">,</span> <span class="mi">1</span><span class="o">)</span> <span class="o">::</span>
 <span class="o">(</span><span class="n">userArtistsIDS</span><span class="o">.</span><span class="n">columnIDs</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">artistMap</span><span class="o">(</span><span class="s">"Wu-Tang Clan"</span><span class="o">)).</span><span class="n">get</span><span class="o">,</span> <span class="mi">1</span><span class="o">)</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">,</span> 
 <span class="n">cardinality</span> <span class="k">=</span> <span class="n">userArtistsIDS</span><span class="o">.</span><span class="n">columnIDs</span><span class="o">.</span><span class="n">size</span>
<span class="o">)</span>



<span class="k">val</span> <span class="n">kilroyUserTags</span> <span class="k">=</span> <span class="n">svec</span><span class="o">(</span>
 <span class="o">(</span><span class="n">userTagsIDS</span><span class="o">.</span><span class="n">columnIDs</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">tagsMap</span><span class="o">(</span><span class="s">"classical"</span><span class="o">)).</span><span class="n">get</span><span class="o">,</span> <span class="mi">1</span><span class="o">)</span> <span class="o">::</span>
 <span class="o">(</span><span class="n">userTagsIDS</span><span class="o">.</span><span class="n">columnIDs</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">tagsMap</span><span class="o">(</span><span class="s">"skacore"</span><span class="o">)).</span><span class="n">get</span><span class="o">,</span> <span class="mi">1</span><span class="o">)</span> <span class="o">::</span>
 <span class="o">(</span><span class="n">userTagsIDS</span><span class="o">.</span><span class="n">columnIDs</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">tagsMap</span><span class="o">(</span><span class="s">"why on earth is this just a bonus track"</span><span class="o">)).</span><span class="n">get</span><span class="o">,</span> <span class="mi">1</span><span class="o">)</span> <span class="o">::</span>
 <span class="o">(</span><span class="n">userTagsIDS</span><span class="o">.</span><span class="n">columnIDs</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">tagsMap</span><span class="o">(</span><span class="s">"punk rock"</span><span class="o">)).</span><span class="n">get</span><span class="o">,</span> <span class="mi">1</span><span class="o">)</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">,</span>
 <span class="n">cardinality</span> <span class="k">=</span> <span class="n">userTagsIDS</span><span class="o">.</span><span class="n">columnIDs</span><span class="o">.</span><span class="n">size</span><span class="o">)</span>
</code></pre></div></div>

<p>So what we have then is me typing in a name to <code class="highlighter-rouge">artistMap</code> where the keys are human readable names of my favorite bands, which returns the value which is the LastFM ID, which in turn is the key in the BiDictionary map, and returns the matrix position.  I’m making a sparse vector where I want the index at the value I just fetched (which in an awry way refers to the artist I specified) to have the value 1.</p>

<p>Same idea for the tags.</p>

<p>I now have two history vectors.  I didn’t make one for the users table, because I don’t have any friends on LastFM yet. That’s about to change though, because I’m about to have some friends recommended to me.</p>

<p>val kilroysRecs = (artistReccosLlrDrmListByArtist(0).matrix %<em>% kilroyUserArtists + artistReccosLlrDrmListByArtist(1).matrix %</em>% kilroyUserTags).collect
Finally let’s sort that vector out and get some user ids and strengths.</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">org.apache.mahout.math.scalabindings.MahoutCollections._</span>
<span class="k">import</span> <span class="nn">collection._</span>
<span class="k">import</span> <span class="nn">JavaConversions._</span>

<span class="c1">// Which Users I should Be Friends with.
</span><span class="n">println</span><span class="o">(</span><span class="n">kilroysRecs</span><span class="o">(::,</span> <span class="mi">0</span><span class="o">).</span><span class="n">toMap</span><span class="o">.</span><span class="n">toList</span><span class="o">.</span><span class="n">sortWith</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">_2</span> <span class="o">&gt;</span> <span class="k">_</span><span class="o">.</span><span class="n">_2</span><span class="o">).</span><span class="n">take</span><span class="o">(</span><span class="mi">5</span><span class="o">))</span>

</code></pre></div></div>

<p><code class="highlighter-rouge">kilroysRecs</code> is actually a one column matrix, so we take that, and the convert it into something we can sort. We then take the top 5 suggestions.  Keep in mind, this will return the Mahout user ID, which you would also have to reverse map back to the lastFM userID.  The lastFM userID is just another Integer, and not particularly exciting so I left that out.</p>

<p>If you wanted to recommend artists like a normal recommendation engine- you would change the first position in all of the input matrices to be “artistID”. This is left as an exercise to the user.</p>

<p><a href="cco-lastfm.scala">Full Scala Worksheet</a></p>
